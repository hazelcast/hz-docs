= Pooled Native Memory
:page-enterprise: true

POOLED native memory uses internal memory pools to manage native memory blocks.

include::storage:high-density-memory.adoc[tags=pooled-native-list]

POOLED supports two manager types: a per-thread manager and a global manager.

== 1. Per-thread Manager (Thread Local Pooling Memory Manager)

* A thread must register to the Pooling Memory Manager before it can use the Thread Local Pooling Memory Manager (TLPMM).
* Once registered, the thread gets its own TLPMM, and all allocations and frees stay inside it.
* Pages are never shared between threads.
* Because memory is split across threads, one thread can run out of memory even when other threads still have free memory available.

== 2. Global Manager (Global Pooling Memory Manager)

* A single global manager shared by all unregistered threads.
* Pages are shared globally.
* High concurrency can cause contention, since many threads may compete for the same pool.

== Fragmentation

Fragmentation happens when the allocator cannot provide a block of the requested size, even though there is enough total free memory. There are two main types: internal fragmentation and external fragmentation.

=== Internal Fragmentation

The buddy memory allocation system may cause internal fragmentation depending on the size of the memory allocation request and configured page sizes. Since memory is allocated in block sizes that are a power-of-two, a request that does not exactly match the available block size will result in allocation of the next largest block, potentially leaving unused space. For example, when using 128 KB page sizes, a 68 KB request will result in the allocation of a 128 KB block, wasting 60 KB.

=== External Fragmentation

The buddy memory allocation system reduces external fragmentation by merging contiguous free buddy blocks of the same size into larger ones. However, it may still lead to external fragmentation if the system does not have large enough free blocks to allocate for the request. As a result, larger memory requests might fail, even if the total free memory is enough.

==== External Fragmentation in per-thread manager (TLPMM)

Because pages cannot be shared between threads, external fragmentation for TLPMM is more likely when:

* The total native memory is small.
* There is not enough memory available for each partition thread (2 GB total native memory and 8 partition threads means each thread will have ~256 MB).
* The workload includes frequent put/remove operations or a mix of small and large entries.

Even if only a small amount of the memory is used, one partition thread may still run out of memory because it cannot borrow free blocks from others, and no free page is available from the native memory. As a result, a member can fail with NativeOutOfMemoryError even when total free memory appears large. This happens when a single thread's pool runs out of contiguous free blocks for the requested allocation size.

To make fragmentation and memory usage easier to observe, the following details are provided in the Native OOME message:

* **Max page fragmentation percentage across all threads**: Shows how far a memory pool is from being able to provide a full-page-sized block. It indicates the thread with the highest fragmentation level. The value ranges between 0% (no fragmentation) and 100% (high fragmentation).
* **Imbalance memory distribution across threads**: Measures how unevenly memory is distributed across partition threads. It is calculated as the https://en.wikipedia.org/wiki/Coefficient_of_variation[Coefficient of Variation (CV)] of memory usage among threads. A low CV indicates balanced memory usage, a high CV indicates that some threads have much more or much less assigned memory than others, which can lead to early Native OOMEs.
* **Total unusable free memory in all thread pools**: Shows the total amount of free memory that cannot currently be used for allocations because one of the threads has run out of usable memory due to insufficient free space or because its remaining memory is fragmented into blocks too small to satisfy allocation requests.
* **Total allocated memory in all thread pools and global allocator**: Shows the total amount of allocated memory.
* **Total allocated external memory in all thread pools and global allocator**: Shows the total amount of externally allocated memory. External allocation happens when the requested size is larger than the page size.
